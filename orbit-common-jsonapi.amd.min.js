define("orbit-common/jsonapi-source",["orbit/main","orbit/lib/assert","orbit/lib/objects","./source","./jsonapi-serializer","./lib/exceptions","exports"],function(a,b,c,d,e,f,g){"use strict";var h=a["default"],i=b.assert,j=c.isArray,k=d["default"],l=e["default"],m=f.RecordNotFoundException,n=f.RecordAlreadyExistsException,o=k.extend({init:function(a,b){if(i("JSONAPISource requires Orbit.Promise be defined",h.Promise),i("JSONAPISource requires Orbit.ajax be defined",h.ajax),this._super.apply(this,arguments),b=b||{},this.namespace=b.namespace,this.headers=b.headers,this.host=b.host,!b.skipDefaultSerializer){var c=b.defaultSerializerClass||l;this.defaultSerializer=new c(a)}},_transform:function(a){var b,c,d=this,e=a.op,f=a.path,g=a.value,h=f[0],i=f[1];if(f.length>2){if(b=this.schema.localToRemoteId(h,i),!b)throw new m(h,i);var j=this.buildURL(h,b);if(f=f.slice(2),"__rel"===f[0]){f[0]="links";var k,l=f[1],o=this._cache.schema.models[h].links[l];"remove"===e?f.length>2&&(k=f.pop(),f.push(this.schema.localToRemoteId(o.model,k))):(f.length>2?(k=f.pop(),f.push("-")):k=g,g=this.schema.localToRemoteId(o.model,k))}var p={op:e,path:j+"/"+f.join("/")};return g&&(p.value=g),this.ajax(j,"PATCH",{data:p}).then(function(){d._transformCache(a)})}if("add"===e){if(i){var q=d.retrieve([h,i]);if(q)throw new n(h,i)}return this.ajax(this.buildURL(h),"POST",{data:this.serialize(h,g)}).then(function(a){a[d.schema.pluralize(h)][d.schema.idField]=i,c=d.deserialize(h,a)})}if(b=this.schema.localToRemoteId(h,i),!b)throw new m(h,i);return"replace"===e?this.ajax(this.buildURL(h,b),"PUT",{data:this.serialize(h,g)}).then(function(a){a[d.schema.pluralize(h)][d.schema.idField]=i,c=d.deserialize(h,a)}):"remove"===e?this.ajax(this.buildURL(h,b),"DELETE").then(function(){d._transformCache(a)}):void 0},_find:function(a,b){var c;if(!b||"number"!=typeof b&&"string"!=typeof b){if(b&&j(b)){for(var d,e=[],f=[],g=0,h=b.length;h>g;g++)d=b[g],c=null!==d&&"object"==typeof d&&d[this.schema.remoteIdField]?d[this.schema.remoteIdField]:this.schema.localToRemoteId(a,d),c?e.push(c):f.push(d);if(f.length>0)throw new m(a,f);return this._findMany(a,e)}return b&&"object"==typeof b&&b[this.schema.remoteIdField]?this._findOne(a,b[this.schema.remoteIdField]):this._findQuery(a,b)}if(c=this.schema.localToRemoteId(a,b),!c)throw new m(a,b);return this._findOne(a,c)},_addRecordsToCache:function(a,b){var c=this;b.forEach(function(b){c._addRecordToCache(a,b)})},_addRecordToCache:function(a,b){this._transformCache({op:"add",path:[a,this.getId(b)],value:b})},_findOne:function(a,b){var c=this;return this.ajax(this.buildURL(a,b),"GET").then(function(b){var d=c.deserialize(a,b);return c.settleTransforms().then(function(){return d})})},_findMany:function(a,b){var c=this;return this.ajax(this.buildURL(a,b),"GET").then(function(b){var d=c.deserialize(a,b);return c.settleTransforms().then(function(){return d})})},_findQuery:function(a,b){var c=this;return this.ajax(this.buildURL(a),"GET",{data:b}).then(function(b){var d=c.deserialize(a,b);return c.settleTransforms().then(function(){return d})})},_transformCache:function(a){var b;b="add"===a.op?a.path.slice(0,a.path.length-1):a.path,this.retrieve(b)?this._cache.transform(a):this.didTransform(a,[])},ajax:function(a,b,c){var d=this;return new h.Promise(function(e,f){if(c=c||{},c.url=a,c.type=b,c.dataType="json",c.context=d,c.data&&"GET"!==b&&(c.contentType="PATCH"===b?"application/json-patch+json; charset=utf-8":"application/vnd.api+json; charset=utf-8",c.data=JSON.stringify(c.data)),void 0!==d.headers){var g=d.headers;c.beforeSend=function(a){for(var b in g)g.hasOwnProperty(b)&&a.setRequestHeader(b,g[b])}}c.success=function(a){e(a)},c.error=function(a){a&&(a.then=null),f(a)},h.ajax(c)})},buildURL:function(a,b){var c=this.host,d=this.namespace,e=[];return c&&e.push(c),d&&e.push(d),e.push(this.pathForType(a)),b&&e.push(j(b)?b.join(","):b),e=e.join("/"),c||(e="/"+e),e},pathForType:function(a){return this.schema.pluralize(a)},serializerForType:function(){return this.defaultSerializer},serialize:function(a,b){return this.serializerForType(a).serialize(a,b)},deserialize:function(a,b){var c=this.serializerForType(a).deserialize(a,b),d=c[a];return this._cache&&(j(d)?this._addRecordsToCache(a,d):this._addRecordToCache(a,d),c.linked&&Object.keys(c.linked).forEach(function(a){this._addRecordsToCache(a,c.linked[a])},this)),d}});g["default"]=o}),define("orbit-common/jsonapi-serializer",["./serializer","orbit/lib/objects","exports"],function(a,b,c){"use strict";var d=a["default"],e=b.clone,f=b.isArray,g=d.extend({serialize:function(a,b){var c=e(b);if(delete c.__normalized,delete c.__rev,delete c.__meta,this.schema.idField!==this.schema.remoteIdField&&delete c[this.schema.idField],c.__rel){var d=Object.keys(c.__rel);if(d.length>0){var f={};d.forEach(function(a){var b=c.__rel[a];f[a]=null!==b&&"object"==typeof b?Object.keys(b):b}),c.links=f}delete c.__rel}var g=this.keyFromType(a),h={};return h[g]=c,h},deserialize:function(a,b){var c=this.normalize(a,b);return this.assignLinks(a,c),c},keyFromType:function(a){return this.schema.pluralize(a)},typeFromKey:function(a){return this.schema.singularize(a)},assignLinks:function(a,b){var c=b[a],d=b.linked;f(c)?this.assignLinksToRecords(a,c):this.assignLinksToRecord(a,c),d&&Object.keys(d).forEach(function(a){this.assignLinksToRecords(a,d[a])},this)},assignLinksToRecords:function(a,b){b.forEach(function(b){this.assignLinksToRecord(a,b)},this)},assignLinksToRecord:function(a,b){if(b.links){b.__meta.links=b.__meta.links||{};var c,d,e,g=b.__meta.links,h=this.schema;Object.keys(b.links).forEach(function(i){if(d=b.links[i],c=h.models[a].links[i],"hasMany"===c.type&&f(d)){b.__rel[i]=b.__rel[i]||[];{b.__rel[i]}d.forEach(function(a){e=h.remoteToLocalId(c.model,a),b.__rel[i][e]=e})}else"hasOne"!==c.type||"string"!=typeof d&&"number"!=typeof d?g[i]=d:(e=h.remoteToLocalId(c.model,d),b.__rel[i]=e)},this),delete b.links}},normalize:function(a,b){var c={},d=(this.schema,this.keyFromType(a)),e=b[d];c[a]=f(e)?this._normalizeRecords(a,e):this._normalizeRecord(a,e);var g=b.linked;if(g){var h,i;c.linked={},Object.keys(g).forEach(function(a){h=this.typeFromKey(a),i=g[a],c.linked[h]=this._normalizeRecords(h,i)},this)}return c},_normalizeRecords:function(a,b){var c=this,d=[];return b.forEach(function(b){d.push(c._normalizeRecord(a,b))}),d},_normalizeRecord:function(a,b){return this.schema.normalize(a,b)}});c["default"]=g});